<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ecom.javacodings.customer.access.orders.OrderDAO">
	<!-- Region Metadata -->

	<select id="countOrdersByMemberId" parameterType="String">
		SELECT COUNT(ORDER_ID)
		FROM ORDERS
		WHERE MEMBER_ID = #{member_id}
	</select>

	<select id="isExistOrderId">
		SELECT CASE WHEN COUNT(ORDER_ID) > 0 THEN '1' ELSE '0' END
		FROM ORDERS
		WHERE ORDER_ID = #{order_id}
	</select>

	<!-- End Region Metadata -->
	<!-- Region Basic CRUD -->

	<select id="findUnPayedOrderByOrderId" resultType="orderDTO">
		SELECT O.ORDER_ID, O.ITEM_ID, O.MEMBER_ID, O.TRANSACTION_ID, O.AMOUNT,
			   TO_CHAR(S.REG_DATE, 'YYYYMMDDHH24MISS') AS REG_DATE, S.STATE
		FROM ORDERS O JOIN ORDER_STATES S ON O.ORDER_ID = S.ORDER_ID
		WHERE
			(SELECT MAX(S.STATE) FROM ORDERS WHERE O.ORDER_ID = #{order_id}) = '0'
			AND O.ORDER_ID = #{order_id}
	</select>

	<select id="getItemIdByOrderId" resultType="String">
		SELECT ITEM_ID
		FROM ORDERS
		WHERE ORDER_ID = #{order_id}
	</select>

	<insert id="addOrder" parameterType="cartDTO" useGeneratedKeys="false">
		INSERT ALL
			INTO ORDERS(ORDER_ID, ITEM_ID, MEMBER_ID, AMOUNT)
			VALUES (#{item.order_id}, #{item.item_id}, #{item.member_id}, #{item.amount})

			INTO ORDER_STATES(ORDER_ID, STATE)
			VALUES (#{item.order_id}, 0)
		SELECT 1 FROM DUAL
	</insert>

	<insert id="increaseStateByOrderId">
		INSERT INTO ORDER_STATES (ORDER_ID,STATE, REG_DATE) VALUES
		(#{order_id}, (SELECT MAX(STATE) FROM ORDER_STATES) + 1,
		 TO_DATE(#{reg_date}, 'YYYYMMDDHH24MISS'))
	</insert>

	<update id="updateOrderStateByOrderID" parameterType="orderDTO">
		UPDATE ORDER_STATES SET
			STATE = #{state}
		WHERE ORDER_ID = #{order_id}
	</update>

	<update id="setTransactionIdByOrderId">
		UPDATE ORDERS SET
			TRANSACTION_ID = #{transaction_id}
		WHERE ORDER_ID = #{order_id}
	</update>

	<!-- End Region Basic CRUD -->
</mapper>
 