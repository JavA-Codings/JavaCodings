<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ecom.javacodings.customer.access.ItemDAO">
    <!-- Region Metadata -->

    <select id="countItems" resultType="Integer">
        SELECT COUNT(ITEM_ID)
        FROM ITEMS
    </select>

    <select id="countItemsByTagID" resultType="Integer" parameterType="String">
        SELECT COUNT(ITEM_ID)
        FROM ITEMS I
        JOIN ITEMS_TAGS T ON I.ITEM_ID = T.ITEM_ID
        WHERE T.TAG_ID = #{value}
    </select>

    <select id="countItemsByCategory" resultType="Integer" parameterType="String">
        SELECT COUNT(ITEM_ID)
        FROM  ITEMS
        WHERE CATEGORY = #{value}
    </select>

    <!-- End Region Metadata -->
    <!-- Region Basic CRUD -->

    <select id="findItemByItemID" parameterType="itemDTO" resultType="itemDTO">
        SELECT *
        FROM ITEMS
        WHERE ITEM_ID = #{item_id}
    </select>

    <select id="findAllItemsByTagID" parameterType="map" resultType="itemDTO">
		SELECT *
		FROM (SELECT I.ITEM_ID, I.LABEL, I.PRICE, II.PATH, ROW_NUMBER() over (ORDER BY I.REG_DATE) AS RN
			FROM ITEMS I
				JOIN ITEM_TAGS IT ON I.ITEM_ID = IT.ITEM_ID
				JOIN ITEM_IMAGES II ON I.ITEM_ID = II.ITEM_ID
				WHERE IT.TAG = #{criteria}
			ORDER BY I.REG_DATE)
		WHERE RN BETWEEN #{start} AND #{end}
    </select>

    <select id="findAllItemsOrderByOrderCount" parameterType="map" resultType="itemDTO">
		SELECT I.LABEL, I."DESC", II.PATH, I.CATEGORY, I.STOCK, I.PRICE 
		FROM (
			SELECT I.LABEL, I."DESC", II.PATH, I.CATEGORY, I.STOCK, I.PRICE, ROW_NUMBER() OVER (ORDER BY ORDER_COUNT DESC) AS RN
			FROM ITEMS I
				JOIN (SELECT ITEM_ID, SUM(QUANTITY) AS ORDER_COUNT
					FROM ORDERS
					GROUP BY ITEM_ID) M ON I.ITEM_ID = M.ITEM_ID 
				JOIN ITEM_IMAGES II ON I.ITEM_ID = II.ITEM_ID
		) WHERE RN BETWEEN #{start} AND #{start}
    </select>

    <select id="findAllItemsOrderByRegDate" parameterType="map" resultType="itemDTO">
        SELECT *
        FROM (SELECT I.ITEM_ID, I.LABEL, I.PRICE, II.PATH,
                     ROW_NUMBER() over (ORDER BY I.REG_DATE DESC) AS RN
              FROM ITEMS I
              JOIN ITEM_IMAGES II ON I.ITEM_ID = II.ITEM_ID)
        WHERE RN BETWEEN #{start} AND #{end}
    </select>

    <!-- End Region Basic CRUD -->
</mapper>